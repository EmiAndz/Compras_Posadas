<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrar Tiendas - Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">ğŸ“‹ Migrar Tiendas a Supabase</h1>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”„ Estado de la MigraciÃ³n</h2>
            <div id="migration-status" class="space-y-2">
                <p class="text-gray-600">Inicializando...</p>
            </div>
            
            <div class="mt-4">
                <button onclick="iniciarMigracion()" 
                        id="migrate-btn"
                        class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 disabled:bg-gray-400">
                    ğŸš€ Iniciar MigraciÃ³n
                </button>
                
                <button onclick="verificarTiendas()" 
                        class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 ml-2">
                    âœ… Verificar Tiendas
                </button>
                
                <button onclick="verificarPoliticasRLS()" 
                        class="bg-yellow-500 text-white px-6 py-2 rounded hover:bg-yellow-600 ml-2">
                    ğŸ”§ Debug RLS
                </button>
                
                <button onclick="testConexion()" 
                        class="bg-purple-500 text-white px-6 py-2 rounded hover:bg-purple-600 ml-2">
                    ğŸ” Test ConexiÃ³n
                </button>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š Tiendas Encontradas</h2>
            <div id="stores-list" class="space-y-3">
                <p class="text-gray-600">Haz clic en "Verificar Tiendas" para ver las tiendas disponibles</p>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <a href="panel-multi-tienda.html" 
               class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 inline-block">
                ğŸ“± Ir al Panel Multi-Tienda
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="assets/js/config/supabase.js"></script>
    <script src="assets/js/services/simpleServices.js"></script>
    
    <script>
        // Tiendas locales de ejemplo para migrar
        const tiendasLocales = [
            {
                nombre: "TechStore Posadas",
                descripcion: "Tu tienda de tecnologÃ­a favorita en Posadas",
                propietario: "Carlos GarcÃ­a",
                email: "ventas@techstore.com.ar",
                telefono: "+54 376 4123456",
                direccion: "Av. Mitre 1234, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "ElectroMax",
                descripcion: "ElectrodomÃ©sticos y tecnologÃ­a de Ãºltima generaciÃ³n",
                propietario: "MarÃ­a RodrÃ­guez",
                email: "info@electromax.com.ar",
                telefono: "+54 376 4234567",
                direccion: "Calle BolÃ­var 567, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "Bella Piel CosmÃ©tica",
                descripcion: "CosmÃ©ticos y productos de belleza premium",
                propietario: "Ana Silva",
                email: "contacto@bellapiel.com.ar",
                telefono: "+54 376 4345678",
                direccion: "Av. Costanera 890, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "Outdoor Life",
                descripcion: "Equipamiento para deportes y vida al aire libre",
                propietario: "Roberto FernÃ¡ndez",
                email: "ventas@outdoorlife.com.ar",
                telefono: "+54 376 4456789",
                direccion: "Villa Cabello, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "PerfumerÃ­a Glamour",
                descripcion: "Perfumes y fragancias importadas",
                propietario: "LucÃ­a MartÃ­nez",
                email: "info@glamour.com.ar",
                telefono: "+54 376 4567890",
                direccion: "Centro, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "Deportes Extremos",
                descripcion: "Equipamiento para deportes extremos y aventura",
                propietario: "Diego LÃ³pez",
                email: "ventas@deportesextremos.com.ar",
                telefono: "+54 376 4678901",
                direccion: "Av. Uruguay 456, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "Fashion Store",
                descripcion: "Moda y accesorios para toda la familia",
                propietario: "Valeria GÃ³mez",
                email: "contacto@fashionstore.com.ar",
                telefono: "+54 376 4789012",
                direccion: "Microcentro, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "Hogar & Deco",
                descripcion: "DecoraciÃ³n y artÃ­culos para el hogar",
                propietario: "Patricia Morales",
                email: "ventas@hogardeco.com.ar",
                telefono: "+54 376 4890123",
                direccion: "Barrio ItaembÃ© MinÃ­, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "LibrerÃ­a Saber",
                descripcion: "Libros, Ãºtiles escolares y material didÃ¡ctico",
                propietario: "Jorge RamÃ­rez",
                email: "info@libreriasaber.com.ar",
                telefono: "+54 376 4901234",
                direccion: "Centro, Posadas, Misiones",
                activa: true,
                verificada: false
            },
            {
                nombre: "JugueterÃ­a Feliz",
                descripcion: "Juguetes educativos y entretenimiento infantil",
                propietario: "MÃ³nica Castro",
                email: "ventas@jugueteriafeliz.com.ar",
                telefono: "+54 376 4012345",
                direccion: "Villa Sarita, Posadas, Misiones",
                activa: true,
                verificada: false
            }
        ];

        // FunciÃ³n para mostrar estado
        function addStatus(message, isError = false) {
            const statusDiv = document.getElementById('migration-status');
            const p = document.createElement('p');
            p.className = isError ? 'text-red-600' : 'text-green-600';
            p.textContent = message;
            statusDiv.appendChild(p);
        }

        // Verificar tiendas existentes
        async function verificarTiendas() {
            try {
                addStatus('ğŸ” Verificando conexiÃ³n a Supabase...');
                
                // Verificar cliente Supabase
                if (!window.supabaseClient) {
                    throw new Error('Cliente Supabase no inicializado');
                }
                
                addStatus('ğŸ” Verificando tiendas en Supabase...');
                
                const result = await window.SimpleSupabaseService.getAllStores();
                
                if (result.success) {
                    const tiendas = result.data;
                    addStatus(`âœ… Encontradas ${tiendas.length} tiendas en Supabase`);
                    
                    mostrarListaTiendas(tiendas);
                    
                    // Verificar cuÃ¡les faltan
                    const nombresExistentes = tiendas.map(t => t.nombre.toLowerCase());
                    const tiendasFaltantes = tiendasLocales.filter(tl => 
                        !nombresExistentes.includes(tl.nombre.toLowerCase())
                    );
                    
                    if (tiendasFaltantes.length > 0) {
                        addStatus(`âš ï¸ Faltan ${tiendasFaltantes.length} tiendas por migrar`);
                        tiendasFaltantes.forEach(t => {
                            addStatus(`   - ${t.nombre}`, false);
                        });
                    } else {
                        addStatus('ğŸ‰ Â¡Todas las tiendas estÃ¡n migradas!');
                    }
                    
                } else {
                    throw new Error(result.error || 'No se pudieron obtener las tiendas');
                }
                
            } catch (error) {
                addStatus(`âŒ Error verificando tiendas: ${error.message}`, true);
                console.error('Error completo:', error);
            }
        }

        // Mostrar lista de tiendas
        function mostrarListaTiendas(tiendas) {
            const listDiv = document.getElementById('stores-list');
            listDiv.innerHTML = '';
            
            if (tiendas.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500">No hay tiendas en la base de datos</p>';
                return;
            }
            
            tiendas.forEach(tienda => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded border';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 font-semibold">${tienda.nombre.charAt(0)}</span>
                        </div>
                        <div>
                            <div class="font-semibold">${tienda.nombre}</div>
                            <div class="text-sm text-gray-600">${tienda.email || 'Sin email'}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm ${tienda.activa ? 'text-green-600' : 'text-red-600'}">
                            ${tienda.activa ? 'âœ… Activa' : 'âŒ Inactiva'}
                        </div>
                        <div class="text-xs text-gray-500">ID: ${tienda.id.substring(0, 8)}...</div>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        // Iniciar migraciÃ³n
        async function iniciarMigracion() {
            const btn = document.getElementById('migrate-btn');
            btn.disabled = true;
            btn.textContent = 'â³ Migrando...';
            
            try {
                addStatus('ğŸš€ Iniciando migraciÃ³n de tiendas...');
                
                // Verificar cliente Supabase
                if (!window.supabaseClient) {
                    throw new Error('Cliente Supabase no inicializado. Recarga la pÃ¡gina.');
                }
                
                // Debug: Verificar conexiÃ³n
                addStatus('ğŸ” Verificando conexiÃ³n...');
                const { data: testData, error: testError } = await window.supabaseClient
                    .from('tiendas')
                    .select('count(*)')
                    .limit(1);
                    
                if (testError) {
                    console.error('Error de conexiÃ³n:', testError);
                    addStatus(`âŒ Error de conexiÃ³n: ${testError.message}`, true);
                    return;
                }
                
                addStatus('âœ… ConexiÃ³n a Supabase OK');
                
                // Obtener tiendas existentes
                let existingNames = [];
                try {
                    const existingResult = await window.SimpleSupabaseService.getAllStores();
                    existingNames = existingResult.success ? 
                        existingResult.data.map(t => t.nombre.toLowerCase()) : [];
                    addStatus(`ğŸ“Š ${existingNames.length} tiendas ya existen en la BD`);
                } catch (error) {
                    addStatus('âš ï¸ No se pudieron obtener tiendas existentes, continuando...');
                    console.warn('Error obteniendo tiendas existentes:', error);
                }
                
                let migradas = 0;
                let saltadas = 0;
                let errores = 0;
                
                for (const [index, tienda] of tiendasLocales.entries()) {
                    try {
                        addStatus(`ğŸ“ Procesando ${index + 1}/${tiendasLocales.length}: ${tienda.nombre}`);
                        
                        if (existingNames.includes(tienda.nombre.toLowerCase())) {
                            addStatus(`â­ï¸ Saltando ${tienda.nombre} (ya existe)`);
                            saltadas++;
                            continue;
                        }
                        
                        // Preparar datos con propietario requerido
                        const datosCompletos = {
                            ...tienda,
                            propietario: tienda.propietario || 'Admin Sistema', // Campo requerido
                            descripcion: tienda.descripcion || `Tienda ${tienda.nombre}`,
                            verificada: false
                        };
                        
                        console.log('Datos a insertar:', datosCompletos);
                        
                        const result = await window.SimpleSupabaseService.createStore(datosCompletos);
                        
                        if (result.success) {
                            addStatus(`âœ… Migrada: ${tienda.nombre}`);
                            migradas++;
                        } else {
                            addStatus(`âŒ Error migrando ${tienda.nombre}: ${result.error}`, true);
                            console.error(`Error detallado para ${tienda.nombre}:`, result);
                            errores++;
                        }
                        
                        // Pausa entre inserciones
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        addStatus(`âŒ ExcepciÃ³n con ${tienda.nombre}: ${error.message}`, true);
                        console.error(`ExcepciÃ³n para ${tienda.nombre}:`, error);
                        errores++;
                    }
                }
                
                addStatus(`ğŸ‰ MigraciÃ³n completada: ${migradas} migradas, ${saltadas} saltadas, ${errores} errores`);
                
                if (migradas > 0) {
                    addStatus('ğŸ”„ Actualizando lista...');
                    setTimeout(verificarTiendas, 2000);
                }
                
            } catch (error) {
                addStatus(`âŒ Error general en migraciÃ³n: ${error.message}`, true);
                console.error('Error completo en migraciÃ³n:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ Iniciar MigraciÃ³n';
            }
        }

        // Test de conexiÃ³n
        async function testConexion() {
            try {
                addStatus('ğŸ” Probando conexiÃ³n a Supabase...');
                
                if (!window.supabaseClient) {
                    throw new Error('Cliente Supabase no disponible');
                }
                
                // Test 1: Ping bÃ¡sico
                const { data: ping, error: pingError } = await window.supabaseClient
                    .from('categorias')
                    .select('count(*)')
                    .limit(1);
                    
                if (pingError) {
                    throw new Error(`Ping fallÃ³: ${pingError.message}`);
                }
                addStatus('âœ… Ping a BD exitoso');
                
                // Test 2: Verificar tabla tiendas
                const { data: tiendas, error: tiendasError } = await window.supabaseClient
                    .from('tiendas')
                    .select('count(*)')
                    .limit(1);
                    
                if (tiendasError) {
                    addStatus(`âŒ Error accediendo tabla tiendas: ${tiendasError.message}`, true);
                    addStatus(`CÃ³digo: ${tiendasError.code}, Detalles: ${tiendasError.details}`, true);
                } else {
                    addStatus('âœ… Tabla tiendas accesible');
                }
                
                // Test 3: Verificar permisos de inserciÃ³n
                try {
                    const { data: testInsert, error: insertError } = await window.supabaseClient
                        .from('tiendas')
                        .insert([{
                            nombre: 'TEST_DELETE_ME',
                            propietario: 'TEST',
                            email: `test_${Date.now()}@test.com`,
                            activa: false
                        }])
                        .select();
                        
                    if (insertError) {
                        addStatus(`âŒ Error permisos INSERT: ${insertError.message}`, true);
                        if (insertError.code === '42501') {
                            addStatus('ğŸ’¡ Posible problema de polÃ­ticas RLS', true);
                        }
                    } else {
                        addStatus('âœ… Permisos INSERT OK');
                        // Limpiar el registro de prueba
                        await window.supabaseClient
                            .from('tiendas')
                            .delete()
                            .eq('id', testInsert[0].id);
                        addStatus('ğŸ§¹ Registro de prueba eliminado');
                    }
                } catch (insertErr) {
                    addStatus(`âŒ ExcepciÃ³n en test INSERT: ${insertErr.message}`, true);
                }
                
            } catch (error) {
                addStatus(`âŒ Error en test de conexiÃ³n: ${error.message}`, true);
                console.error('Error completo:', error);
            }
        }
        
        // Verificar polÃ­ticas RLS
        async function verificarPoliticasRLS() {
            try {
                addStatus('ğŸ” Verificando polÃ­ticas RLS...');
                
                if (!window.supabaseClient) {
                    throw new Error('Cliente Supabase no disponible');
                }
                
                // Query para verificar polÃ­ticas existentes
                const { data: politicas, error } = await window.supabaseClient
                    .rpc('get_table_policies', { table_name: 'tiendas' })
                    .select('*');
                    
                if (error) {
                    addStatus('âš ï¸ No se pueden consultar polÃ­ticas RLS directamente', false);
                    addStatus('ğŸ’¡ Esto es normal si no tienes permisos de admin', false);
                } else {
                    addStatus(`ğŸ“‹ Encontradas ${politicas.length} polÃ­ticas para tabla tiendas`);
                    politicas.forEach(p => {
                        addStatus(`   - ${p.policyname}: ${p.cmd}`);
                    });
                }
                
                // InformaciÃ³n sobre el problema comÃºn
                addStatus('ğŸ› ï¸ SOLUCIÃ“N RECOMENDADA:', false);
                addStatus('1. Ve a tu panel de Supabase', false);
                addStatus('2. Authentication > Policies', false);
                addStatus('3. Tabla "tiendas" > Crear polÃ­tica', false);
                addStatus('4. Permitir INSERT para todos los roles', false);
                addStatus('5. O ejecuta el script FIX_RLS_TIENDAS.sql', false);
                
            } catch (error) {
                addStatus(`âŒ Error verificando RLS: ${error.message}`, true);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                addStatus('ğŸ“‹ Sistema listo para migraciÃ³n');
                addStatus(`ğŸ“¦ ${tiendasLocales.length} tiendas locales disponibles para migrar`);
                addStatus('ğŸ’¡ Si hay errores, usa "Debug RLS" y "Test ConexiÃ³n"');
            }, 1000);
        });
    </script>
</body>
</html>